<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<meta name="description" content="S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰ TOP 50 â€” 5ë…„ ë°±í…ŒìŠ¤íŠ¸ ê¸°ë°˜ ì „ëµ ì í•©ë„ ë­í‚¹ | Herdvibe">
<title>íŠ¸ë Œë“œ íŒ”ë¡œì‰ TOP 50 | Herdvibe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{scrollbar-width:none}html::-webkit-scrollbar{display:none}
body{background:#000;color:#e4e4e7;font-family:'Noto Sans KR',sans-serif;min-height:100vh}
.m{font-family:'JetBrains Mono',monospace}

/* Nav */
.top-nav{position:sticky;top:0;z-index:100;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);border-bottom:1px solid #1a1a1a;padding:0 16px;display:flex;align-items:center;justify-content:space-between;height:56px}
.nav-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:1.2rem;font-weight:700;color:#e4e4e7;white-space:nowrap}
.nav-links{display:flex;gap:4px}
.nav-link{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;color:#a1a1aa;text-decoration:none;border:1px solid transparent;transition:all .2s;font-family:'Noto Sans KR',sans-serif}
.nav-link:hover{color:#e4e4e7;border-color:#333}
.nav-link.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
.nav-upd{font-size:11px;color:#52525b;display:flex;align-items:center;gap:5px}
.nav-upd .dot{width:6px;height:6px;background:#22c55e;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Container */
.container{max-width:960px;margin:0 auto;padding:16px 12px 60px}

/* Section Title */
.section-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;color:#e4e4e7;margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* Summary Cards */
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.summary-card{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:10px;padding:14px;text-align:center;transition:border-color .2s}
.summary-card:hover{border-color:#333}
.summary-label{font-size:11px;color:#71717a;font-weight:500;margin-bottom:4px}
.summary-value{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:#f4f4f5}
.summary-sub{font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:2px;color:#71717a}

/* Sector Grid */
.sec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px;margin-bottom:16px}
.sec{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:8px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.sec:hover{border-color:#333;transform:translateY(-1px)}
.sec .fill{position:absolute;left:0;top:0;bottom:0;opacity:.06;border-radius:8px}
.sec .sn{font-size:11px;font-weight:500;position:relative;z-index:1}
.sec .ss{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;position:relative;z-index:1}
.sec .si{font-size:9px;color:#71717a;position:relative;z-index:1}

/* Table */
.t50-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.t50-tbl{width:100%;border-collapse:collapse}
.t50-tbl thead th{text-align:left;font-size:11px;color:#71717a;font-weight:500;padding:8px 10px;border-bottom:1px solid #1a1a1a;white-space:nowrap;cursor:pointer;user-select:none;transition:color .2s}
.t50-tbl thead th:hover{color:#e4e4e7}
.t50-tbl thead th .sort-arrow{font-size:9px;margin-left:3px;color:#3b82f6}
.t50-row{cursor:pointer;transition:background .15s}
.t50-row:hover{background:#111}
.t50-row td{padding:10px;font-size:13px;border-bottom:1px solid #111;white-space:nowrap}

/* Signal Badge */
.sb{display:inline-block;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;letter-spacing:.3px;white-space:nowrap}
.sb-STRONG_BUY{background:rgba(34,197,94,.1);color:#22c55e;border:1px solid rgba(34,197,94,.2)}
.sb-BUY{background:rgba(59,130,246,.1);color:#3b82f6;border:1px solid rgba(59,130,246,.2)}
.sb-HOLD{background:rgba(234,179,8,.1);color:#eab308;border:1px solid rgba(234,179,8,.2)}
.sb-SELL{background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2)}
.sc-bar{width:50px;height:4px;background:#1a1a1a;border-radius:2px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:5px}
.sc-fill{height:100%;border-radius:2px}

/* Colors */
.pos{color:#22c55e}.neg{color:#ef4444}
.tk{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:13px;color:#3b82f6}
.tn{font-size:10px;color:#71717a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px}
.trophy{color:#f59e0b;font-size:10px;margin-right:2px}
.pz{display:inline-block;padding:2px 4px;border-radius:3px;font-size:9px;font-family:'JetBrains Mono',monospace;margin-right:1px;font-weight:600}
.pz-y{background:rgba(34,197,94,.1);color:#22c55e}.pz-n{background:#111;color:#52525b}

/* Share */
.share-bar{display:flex;gap:6px;justify-content:center;margin:12px 0 4px;flex-wrap:wrap}
.share-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid #222;background:#0a0a0a;color:#a1a1aa;font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all .2s}
.share-btn:hover{border-color:#444;color:#e4e4e7}
.share-btn svg{width:14px;height:14px;flex-shrink:0}
.share-btn.twitter:hover{border-color:#1d9bf0;color:#1d9bf0}
.share-btn.kakao:hover{border-color:#fee500;color:#fee500}
.share-btn.telegram:hover{border-color:#26a5e4;color:#26a5e4}
.share-btn.copy:hover{border-color:#22c55e;color:#22c55e}
.share-btn.copied{border-color:#22c55e;color:#22c55e}
.share-btn.instagram:hover{border-color:#e1306c;color:#e1306c}
.share-btn.instagram.copied{border-color:#e1306c;color:#e1306c}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#000;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* Detail Overlay */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:200;backdrop-filter:blur(4px);overflow-y:auto;-webkit-overflow-scrolling:touch}
.overlay.show{display:block}
.dp{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:16px;width:94%;max-width:820px;margin:20px auto;padding:20px;position:relative}
.dp-close{position:absolute;top:12px;right:12px;background:#111;border:1px solid #1a1a1a;border-radius:7px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:#a1a1aa;cursor:pointer;font-size:15px;transition:.2s;z-index:10}
.dp-close:hover{border-color:#ef4444;color:#ef4444}
.dp-hd{display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;padding-right:36px}
.dp-tk{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:#3b82f6}
.dp-nm{font-size:12px;color:#a1a1aa}
.dp-sec-tag{font-size:9px;background:#111;padding:2px 7px;border-radius:4px;color:#71717a;border:1px solid #1a1a1a;display:inline-block;margin-top:2px}
.dp-right{margin-left:auto;text-align:right}
.dp-right .big{font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;line-height:1}
.dp-tv{background:#111;border:1px solid #1a1a1a;border-radius:10px;overflow:hidden;margin-bottom:14px}
.dp-charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.dp-chart{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:10px;padding:12px}
.dp-chart h4{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#71717a;margin-bottom:8px}
.dp-chart-wrap{position:relative;height:170px}
.dp-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.dc{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:10px;padding:12px}
.dc h4{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#71717a;margin-bottom:6px}
.dr{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px}
.dr .dl{color:#a1a1aa}.dr .dv{font-family:'JetBrains Mono',monospace;font-weight:600}
.bt-sec{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:10px;padding:12px}
.bt-sec h4{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#71717a;margin-bottom:8px}
.bt-g{display:grid;grid-template-columns:repeat(auto-fit,minmax(85px,1fr));gap:6px}
.bt-s{text-align:center;padding:8px;background:#111;border-radius:7px}
.bt-s .bv{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.bt-s .blab{font-size:9px;color:#71717a;margin-top:1px}

/* Last updated */
.last-updated{text-align:center;font-size:11px;color:#52525b;margin-top:8px}

@media(max-width:768px){
  .top-nav{padding:0 10px;height:50px}
  .nav-title{font-size:1rem}
  .summary-grid{grid-template-columns:repeat(2,1fr)}
  .sec-grid{grid-template-columns:repeat(2,1fr)}
  .dp{padding:14px;width:97%;margin:10px auto}
  .dp-charts,.dp-grid{grid-template-columns:1fr}
  .dp-tk{font-size:18px}.dp-right .big{font-size:28px}
  .dp-chart-wrap{height:140px}
  .t50-tbl .hm2{display:none}
  .nav-upd{display:none}
}
</style>
</head>
<body>

<nav class="top-nav">
  <div class="nav-title">S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰</div>
  <div class="nav-links">
    <a class="nav-link active" href="#">TOP 50</a>
    <a class="nav-link" href="trend_all.html">ì „ì²´ ì¢…ëª©</a>
  </div>
  <div class="nav-upd"><span class="dot"></span><span id="ut">ë¡œë”©ì¤‘...</span></div>
</nav>

<div class="container">

<!-- Share -->
<div class="share-bar">
  <button class="share-btn twitter" onclick="shareTwitter()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>íŠ¸ìœ„í„°</button>
  <button class="share-btn kakao" onclick="shareKakao()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.52 0-10 3.36-10 7.5 0 2.66 1.74 5 4.36 6.33-.14.53-.9 3.4-.93 3.61 0 0-.02.17.09.23.11.07.24.03.24.03.32-.04 3.7-2.42 4.28-2.83.62.09 1.27.13 1.96.13 5.52 0 10-3.36 10-7.5S17.52 3 12 3z"/></svg>ì¹´ì¹´ì˜¤í†¡</button>
  <button class="share-btn telegram" onclick="shareTelegram()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>í…”ë ˆê·¸ë¨</button>
  <button class="share-btn instagram" onclick="shareInstagram(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>ì¸ìŠ¤íƒ€ê·¸ë¨</button>
  <button class="share-btn copy" onclick="copyLink(this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë§í¬ë³µì‚¬</button>
</div>

<!-- Summary -->
<div class="summary-grid" id="ovGrid"></div>

<!-- Sectors -->
<div class="sec-grid" id="secGrid"></div>

<!-- TOP 50 Table -->
<div class="section-title">ğŸ† TOP 50 â€” íŠ¸ë Œë“œ íŒ”ë¡œì‰ ìµœì  ì¢…ëª©</div>
<div class="t50-wrap">
  <table class="t50-tbl" id="t50tbl">
    <thead><tr>
      <th data-sort="rank"># <span class="sort-arrow"></span></th>
      <th>ì¢…ëª©</th>
      <th data-sort="fitness">ì í•©ë„ <span class="sort-arrow"></span></th>
      <th data-sort="return">5ë…„ ìˆ˜ìµ <span class="sort-arrow"></span></th>
      <th data-sort="excess">ì´ˆê³¼ìˆ˜ìµ <span class="sort-arrow"></span></th>
      <th class="hm2" data-sort="winrate">ìŠ¹ë¥  <span class="sort-arrow"></span></th>
      <th class="hm2" data-sort="wlr">ìˆ˜ìµ/ì†ì‹¤ <span class="sort-arrow"></span></th>
      <th data-sort="signal">í˜„ì¬ ì‹ í˜¸ <span class="sort-arrow"></span></th>
      <th data-sort="score">í˜„ì¬ ì ìˆ˜ <span class="sort-arrow"></span></th>
    </tr></thead>
    <tbody id="t50body"></tbody>
  </table>
</div>

<div class="last-updated">5ë…„ ë°±í…ŒìŠ¤íŠ¸ ê¸°ë°˜ Â· ì „ëµ ì í•©ë„ ë­í‚¹</div>

</div><!-- container -->

<!-- Detail Overlay -->
<div class="overlay" id="ol"><div class="dp" id="dp"></div></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
let D=null,H=null;
let t50sort='fitness',t50dir='desc';
let csf=null;
let eqCI=null,yrCI=null;

const SC=s=>s>=75?'#22c55e':s>=60?'#3b82f6':s>=40?'#eab308':'#ef4444';
const FC=s=>s>=70?'#22c55e':s>=50?'#3b82f6':s>=35?'#eab308':'#ef4444';
const SN={'STRONG_BUY':'ê°•í•œë§¤ìˆ˜','BUY':'ë§¤ìˆ˜','HOLD':'ê´€ë§','SELL':'ë§¤ë„'};
const SIG_ORDER={'STRONG_BUY':4,'BUY':3,'HOLD':2,'SELL':1};
const FN=n=>n==null?'-':n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

async function init(){
  try{D=await(await fetch('trend_data.json')).json()}catch{document.getElementById('t50body').innerHTML='<tr><td colspan="9" style="text-align:center;padding:40px;color:#71717a">trend_data.json ë¡œë“œ ì‹¤íŒ¨</td></tr>';return}
  try{H=await(await fetch('trend_history.json')).json()}catch{H=[]}
  document.getElementById('ut').textContent=D.updated;
  renderOv();renderSec();renderTop50();
}

function renderOv(){
  const m=D.market_summary;
  const c=[
    {l:'ë¶„ì„ ì¢…ëª©',v:m.total_stocks,c:'#f4f4f5'},
    {l:'í‰ê·  ì ìˆ˜',v:m.avg_score,c:SC(m.avg_score),s:`ì¤‘ì•™ê°’ ${m.median_score}`},
    {l:'ê°•í•œë§¤ìˆ˜',v:m.strong_buy_count,c:'#22c55e',s:`${(m.strong_buy_count/m.total_stocks*100).toFixed(0)}%`},
    {l:'ë§¤ìˆ˜',v:m.buy_count,c:'#3b82f6',s:`${(m.buy_count/m.total_stocks*100).toFixed(0)}%`},
    {l:'ê´€ë§',v:m.hold_count,c:'#eab308',s:`${(m.hold_count/m.total_stocks*100).toFixed(0)}%`},
    {l:'ë§¤ë„',v:m.sell_count,c:'#ef4444',s:`${(m.sell_count/m.total_stocks*100).toFixed(0)}%`}
  ];
  document.getElementById('ovGrid').innerHTML=c.map(x=>`<div class="summary-card"><div class="summary-label">${x.l}</div><div class="summary-value" style="color:${x.c}">${x.v}</div>${x.s?`<div class="summary-sub">${x.s}</div>`:''}</div>`).join('');
}

function renderSec(){
  const ss=D.sector_summary;const sorted=Object.entries(ss).sort((a,b)=>b[1].avg_score-a[1].avg_score);
  document.getElementById('secGrid').innerHTML=sorted.map(([n,d])=>{const c=SC(d.avg_score);const a=csf===n;
    return `<div class="sec${a?' active':''}" onclick="csf=csf==='${n}'?null:'${n}';renderSec();renderTop50()" style="${a?`border-color:${c}`:''}"><div class="fill" style="width:${d.avg_score}%;background:${c}"></div><div><div class="sn">${n}</div><div class="si">${d.count}ì¢…ëª©</div></div><div class="ss" style="color:${c}">${d.avg_score}</div></div>`}).join('');
}

function getT50Val(s,key){
  switch(key){
    case'rank':return s.fitness_rank;case'fitness':return s.strategy_fitness;
    case'return':return s.backtest.total_return;case'excess':return s.backtest.excess_return;
    case'winrate':return s.backtest.win_rate;case'wlr':return s.backtest.win_loss_ratio;
    case'signal':return SIG_ORDER[s.signal]||0;case'score':return s.trend_score;default:return 0;
  }
}

function renderTop50(){
  let top50=D.stocks.slice().sort((a,b)=>b.strategy_fitness-a.strategy_fitness).slice(0,50);
  if(csf) top50=top50.filter(s=>s.sector===csf);
  const m=t50dir==='desc'?-1:1;
  top50.sort((a,b)=>(getT50Val(a,t50sort)-getT50Val(b,t50sort))*m);

  document.querySelectorAll('#t50tbl thead th').forEach(th=>{
    const arrow=th.querySelector('.sort-arrow');if(!arrow)return;
    const key=th.dataset.sort;
    arrow.textContent=key===t50sort?(t50dir==='desc'?' â–¼':' â–²'):'';
  });

  document.getElementById('t50body').innerHTML=top50.map(s=>{
    const bt=s.backtest,fc=FC(s.strategy_fitness);
    return `<tr class="t50-row" onclick="showD('${s.ticker}')">
      <td class="m" style="color:#f59e0b;font-size:11px;font-weight:700">${s.fitness_rank}</td>
      <td><div class="tk">ğŸ† ${s.ticker}</div><div class="tn">${s.name}</div></td>
      <td><span class="m" style="font-weight:700;font-size:15px;color:${fc}">${s.strategy_fitness}</span></td>
      <td class="m" style="font-weight:600"><span class="${bt.total_return>=0?'pos':'neg'}">${bt.total_return>=0?'+':''}${bt.total_return}%</span></td>
      <td class="m" style="font-weight:600"><span class="${bt.excess_return>=0?'pos':'neg'}">${bt.excess_return>=0?'+':''}${bt.excess_return}%</span></td>
      <td class="hm2 m" style="color:${bt.win_rate>=50?'#22c55e':'#ef4444'}">${bt.win_rate}%</td>
      <td class="hm2 m">${bt.win_loss_ratio}</td>
      <td><span class="sb sb-${s.signal}">${SN[s.signal]}</span></td>
      <td><span class="m" style="font-weight:700;color:${SC(s.trend_score)}">${s.trend_score}</span><span class="sc-bar"><span class="sc-fill" style="width:${s.trend_score}%;background:${SC(s.trend_score)}"></span></span></td>
    </tr>`}).join('')||'<tr><td colspan="9" style="text-align:center;padding:40px;color:#71717a">ê²°ê³¼ ì—†ìŒ</td></tr>';
}

/* Detail Panel */
function showD(tk){
  const s=D.stocks.find(x=>x.ticker===tk);if(!s)return;
  const sc=SC(s.trend_score),fc=FC(s.strategy_fitness),pt=s.profit_taking,bt=s.backtest,ind=s.indicators;
  const hasEC=bt.equity_curve&&bt.equity_curve.length>0;
  const hasYR=bt.yearly_returns&&Object.keys(bt.yearly_returns).length>0;
  const tvSymbol=s.ticker.replace('-','.');

  let html=`<div class="dp-close" onclick="closeD()">âœ•</div>
  <div class="dp-hd"><div><div class="dp-tk">${s.ticker}</div><div class="dp-nm">${s.name}</div><span class="dp-sec-tag">${s.sector}</span></div>
  <div class="dp-right">
    <div style="display:flex;gap:10px;align-items:flex-end;justify-content:flex-end">
      <div style="text-align:right"><div style="font-size:9px;color:#71717a">ì í•©ë„</div><div class="big" style="color:${fc}">${s.strategy_fitness}</div></div>
      <div style="text-align:right"><div style="font-size:9px;color:#71717a">ì ìˆ˜</div><div class="big" style="color:${sc}">${s.trend_score}</div></div>
    </div>
    <span class="sb sb-${s.signal}" style="margin-top:4px;display:inline-block">${SN[s.signal]}${s.fitness_rank<=50?' ğŸ† TOP '+s.fitness_rank:''}</span>
  </div></div>`;

  html+=`<div class="dp-tv"><div id="tv-widget" style="height:350px"></div></div>`;
  html+=`<div class="dp-charts">`;
  if(hasEC) html+=`<div class="dp-chart"><h4>ğŸ’¹ 5ë…„ ìˆ˜ìµê³¡ì„  (ì „ëµ vs ë‹¨ìˆœë³´ìœ )</h4><div class="dp-chart-wrap"><canvas id="eqCanvas"></canvas></div></div>`;
  if(hasYR) html+=`<div class="dp-chart"><h4>ğŸ“… ì—°ë„ë³„ ìˆ˜ìµë¥  ë¹„êµ</h4><div class="dp-chart-wrap"><canvas id="yrCanvas"></canvas></div></div>`;
  html+=`</div>`;

  html+=`<div class="bt-sec"><h4>ğŸ“Š 5ë…„ ë°±í…ŒìŠ¤íŠ¸ Â· ${bt.total_trades}íšŒ ê±°ë˜</h4>
    <div class="bt-g">
      <div class="bt-s"><div class="bv" style="color:${bt.win_rate>=50?'#22c55e':'#ef4444'}">${bt.win_rate}%</div><div class="blab">ìŠ¹ë¥ </div></div>
      <div class="bt-s"><div class="bv">${bt.total_trades}</div><div class="blab">ì´ ê±°ë˜</div></div>
      <div class="bt-s"><div class="bv pos">+${bt.avg_winner}%</div><div class="blab">í‰ê·  ìˆ˜ìµ</div></div>
      <div class="bt-s"><div class="bv neg">${bt.avg_loser}%</div><div class="blab">í‰ê·  ì†ì‹¤</div></div>
      <div class="bt-s"><div class="bv" style="color:${bt.total_return>=0?'#22c55e':'#ef4444'}">${bt.total_return>=0?'+':''}${bt.total_return}%</div><div class="blab">ì „ëµ ìˆ˜ìµ</div></div>
      <div class="bt-s"><div class="bv" style="color:${bt.buy_hold_return>=0?'#22c55e':'#ef4444'}">${bt.buy_hold_return>=0?'+':''}${bt.buy_hold_return}%</div><div class="blab">ë‹¨ìˆœ ë³´ìœ </div></div>
      <div class="bt-s"><div class="bv" style="color:${bt.excess_return>=0?'#22c55e':'#ef4444'}">${bt.excess_return>=0?'+':''}${bt.excess_return}%</div><div class="blab">ì´ˆê³¼ ìˆ˜ìµ</div></div>
      <div class="bt-s"><div class="bv">${bt.win_loss_ratio}</div><div class="blab">ìˆ˜ìµ/ì†ì‹¤</div></div>
      <div class="bt-s"><div class="bv neg">${bt.max_drawdown}%</div><div class="blab">ìµœëŒ€ ë‚™í­</div></div>
      <div class="bt-s"><div class="bv">${bt.profit_factor}</div><div class="blab">ìˆ˜ìµíŒ©í„°</div></div>
    </div></div>`;

  html+=`<div class="dp-grid" style="margin-top:10px">
    <div class="dc"><h4>ğŸ”§ ê¸°ìˆ ì  ì§€í‘œ</h4>
      <div class="dr"><span class="dl">SMA 50 / 200</span><span class="dv">$${FN(ind.sma_50)} / $${FN(ind.sma_200)}</span></div>
      <div class="dr"><span class="dl">RSI (14)</span><span class="dv" style="color:${ind.rsi>70?'#ef4444':ind.rsi<30?'#22c55e':'#e4e4e7'}">${ind.rsi}</span></div>
      <div class="dr"><span class="dl">ADX</span><span class="dv" style="color:${ind.adx>25?'#22c55e':'#71717a'}">${ind.adx}${ind.adx>40?' ğŸ”¥':ind.adx>25?' âœ“':''}</span></div>
      <div class="dr"><span class="dl">Supertrend</span><span class="dv" style="color:${ind.supertrend_dir==='UP'?'#22c55e':'#ef4444'}">${ind.supertrend_dir==='UP'?'â–² ìƒìŠ¹':'â–¼ í•˜ë½'}</span></div>
      <div class="dr"><span class="dl">ATR</span><span class="dv">$${FN(ind.atr)}</span></div>
      <div class="dr"><span class="dl">MACD</span><span class="dv">${ind.macd} / ${ind.macd_signal}</span></div>
    </div>
    <div class="dc"><h4>ğŸ’° ìµì ˆ ì‹ í˜¸</h4>
      <div class="dr"><span class="dl">ì§„ì…ê°€ (${pt.entry_date})</span><span class="dv">$${FN(pt.entry_price)}</span></div>
      <div class="dr"><span class="dl">ìˆ˜ìµë¥ </span><span class="dv ${pt.gain_since_signal>=0?'pos':'neg'}">${pt.gain_since_signal>=0?'+':''}${pt.gain_since_signal}% (${pt.days_in_trend}ì¼)</span></div>
      <div class="dr"><span class="dl">ATR ìŠ¤í†±</span><span class="dv">$${FN(pt.atr_trailing_stop)}</span></div>
      <div style="margin-top:5px;display:flex;gap:3px;flex-wrap:wrap">
        <span class="pz ${pt.reached_10?'pz-y':'pz-n'}">+10% ${pt.reached_10?'âœ“':''}</span>
        <span class="pz ${pt.reached_20?'pz-y':'pz-n'}">+20% ${pt.reached_20?'âœ“':''}</span>
        <span class="pz ${pt.reached_30?'pz-y':'pz-n'}">+30% ${pt.reached_30?'âœ“':''}</span>
      </div>
      <div style="margin-top:6px;padding:6px;background:#111;border-radius:5px;font-size:10px">
        <div class="dr"><span class="dl">EMA-10 ì´íƒˆ</span><span class="dv" style="color:${pt.ema10_exit_warning?'#ef4444':'#22c55e'}">${pt.ema10_exit_warning?'âš  ê²½ê³ ':'âœ“ ì•ˆì „'}</span></div>
        <div class="dr"><span class="dl">ì ìˆ˜ í•˜ë½</span><span class="dv" style="color:${pt.score_drop_warning?'#ef4444':'#22c55e'}">${pt.score_drop_warning?'âš  ê²½ê³ ':'âœ“ ì•ˆì „'}</span></div>
      </div>
    </div>
  </div>`;

  document.getElementById('dp').innerHTML=html;
  document.getElementById('ol').classList.add('show');
  document.body.style.overflow='hidden';
  setTimeout(()=>{loadTV(tvSymbol);if(hasEC)renderEqChart(s);if(hasYR)renderYrChart(s)},100);
}

function loadTV(symbol){
  const el=document.getElementById('tv-widget');if(!el)return;
  const h=window.innerWidth<=768?260:350;el.style.height=h+'px';
  const script=document.createElement('script');script.src='https://s3.tradingview.com/tv.js';
  script.onload=()=>{new TradingView.widget({autosize:true,container_id:'tv-widget',symbol:symbol,interval:'D',timezone:'America/New_York',theme:'dark',style:'1',locale:'kr',toolbar_bg:'#000',enable_publishing:false,hide_side_toolbar:window.innerWidth<=768,allow_symbol_change:false,save_image:false,backgroundColor:'#000',gridColor:'rgba(26,26,26,.6)',studies:['MASimple@tv-basicstudies','MASimple@tv-basicstudies'],studies_overrides:{'moving average.length':50,'moving average.color':'#3b82f6','moving average #2.length':200,'moving average #2.color':'#eab308'}})};
  document.head.appendChild(script);
}

function renderEqChart(s){
  const ec=s.backtest.equity_curve;if(!ec?.length)return;
  const ctx=document.getElementById('eqCanvas');if(!ctx)return;
  const lb=ec.map(e=>e.d.slice(2,7));
  const tm=s.backtest.trade_markers||[];
  const buyPts=new Array(ec.length).fill(null);const sellPts=new Array(ec.length).fill(null);
  tm.forEach(m=>{const idx=ec.findIndex(e=>e.d===m.date);if(idx>=0){if(m.type==='BUY')buyPts[idx]=ec[idx].s;else sellPts[idx]=ec[idx].s}});
  if(eqCI)eqCI.destroy();
  eqCI=new Chart(ctx,{type:'line',data:{labels:lb,datasets:[
    {label:'ì „ëµ',data:ec.map(e=>e.s),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.06)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
    {label:'ë‹¨ìˆœë³´ìœ ',data:ec.map(e=>e.b),borderColor:'#71717a',borderDash:[4,4],tension:.3,pointRadius:0,borderWidth:1.5},
    {label:'â–² ë§¤ìˆ˜',data:buyPts,borderColor:'#22c55e',backgroundColor:'#22c55e',pointStyle:'triangle',pointRadius:6,showLine:false},
    {label:'â–¼ ë§¤ë„',data:sellPts,borderColor:'#ef4444',backgroundColor:'#ef4444',pointStyle:'triangle',rotation:180,pointRadius:6,showLine:false}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},
    plugins:{legend:{labels:{color:'#a1a1aa',font:{size:8},usePointStyle:true}},tooltip:{callbacks:{label:c=>{if(c.dataset.label==='â–² ë§¤ìˆ˜'&&c.raw)return'ë§¤ìˆ˜ '+c.raw;if(c.dataset.label==='â–¼ ë§¤ë„'&&c.raw)return'ë§¤ë„ '+c.raw;return c.dataset.label+': '+c.raw}}}},
    scales:{x:{ticks:{color:'#71717a',font:{size:8},maxTicksLimit:8},grid:{display:false}},y:{ticks:{color:'#71717a',font:{size:8}},grid:{color:'rgba(26,26,26,.6)'}}}}});
}

function renderYrChart(s){
  const yr=s.backtest.yearly_returns;if(!yr)return;
  const ctx=document.getElementById('yrCanvas');if(!ctx)return;
  const years=Object.keys(yr).sort();
  const strat=years.map(y=>yr[y].strategy);const bh=years.map(y=>yr[y].buy_hold);
  if(yrCI)yrCI.destroy();
  yrCI=new Chart(ctx,{type:'bar',data:{labels:years,datasets:[
    {label:'ì „ëµ',data:strat,backgroundColor:strat.map(v=>v>=0?'rgba(59,130,246,.8)':'rgba(239,68,68,.8)'),borderRadius:4,barPercentage:.4,categoryPercentage:.7},
    {label:'ë‹¨ìˆœë³´ìœ ',data:bh,backgroundColor:bh.map(v=>v>=0?'rgba(161,161,170,.4)':'rgba(161,161,170,.3)'),borderRadius:4,barPercentage:.4,categoryPercentage:.7}
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#a1a1aa',font:{size:8}}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.raw>=0?'+':''}${c.raw}%`}}},
    scales:{x:{ticks:{color:'#a1a1aa',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#71717a',font:{size:8},callback:v=>v+'%'},grid:{color:'rgba(26,26,26,.6)'}}}}});
}

function closeD(){
  document.getElementById('ol').classList.remove('show');document.body.style.overflow='';
  if(eqCI){eqCI.destroy();eqCI=null}if(yrCI){yrCI.destroy();yrCI=null}
}

/* Events */
document.getElementById('ol').addEventListener('click',e=>{if(e.target===document.getElementById('ol'))closeD()});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeD()});
document.getElementById('t50tbl').querySelector('thead').addEventListener('click',e=>{
  const th=e.target.closest('th[data-sort]');if(!th)return;
  const key=th.dataset.sort;
  if(t50sort===key) t50dir=t50dir==='desc'?'asc':'desc'; else{t50sort=key;t50dir='desc'}
  renderTop50();
});

/* Share Functions */
const PAGE_URL=encodeURIComponent(window.location.href);
const PAGE_TITLE=encodeURIComponent('S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰ TOP 50 - Herdvibe');
function shareTwitter(){window.open(`https://twitter.com/intent/tweet?text=${PAGE_TITLE}&url=${PAGE_URL}`,'_blank','width=550,height=420')}
function shareKakao(){
  if(typeof Kakao!=='undefined'&&!Kakao.isInitialized())try{Kakao.init('a43ed7b39fac35458f4f9df925a279b5')}catch{}
  if(typeof Kakao!=='undefined'&&Kakao.isInitialized()){Kakao.Share.sendDefault({objectType:'feed',content:{title:'S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰ TOP 50',description:'5ë…„ ë°±í…ŒìŠ¤íŠ¸ ê¸°ë°˜ ì „ëµ ì í•©ë„ ë­í‚¹',imageUrl:'',link:{mobileWebUrl:window.location.href,webUrl:window.location.href}}})}
  else{copyLink(document.querySelector('.share-btn.kakao'))}
}
function shareTelegram(){window.open(`https://t.me/share/url?url=${PAGE_URL}&text=${PAGE_TITLE}`,'_blank','width=550,height=420')}
function shareInstagram(btn){navigator.clipboard.writeText(window.location.href).then(()=>{btn.classList.add('copied');btn.innerHTML=btn.querySelector('svg').outerHTML+'ë§í¬ ë³µì‚¬ë¨!';showToast('ì¸ìŠ¤íƒ€ê·¸ë¨ ìŠ¤í† ë¦¬ì— ë§í¬ë¥¼ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”');setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML=btn.querySelector('svg').outerHTML+'ì¸ìŠ¤íƒ€ê·¸ë¨'},2000)})}
function copyLink(btn){navigator.clipboard.writeText(window.location.href).then(()=>{btn.classList.add('copied');const svg=btn.querySelector('svg').outerHTML;btn.innerHTML=svg+'ë³µì‚¬ë¨!';showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML=svg+'ë§í¬ë³µì‚¬'},2000)})}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

init();
</script>
</body>
</html>
