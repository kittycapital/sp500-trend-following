<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #151d2e;
  --bg-hover: #1c2740;
  --border: #1e2d45;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-green: #22c55e;
  --accent-green-dim: rgba(34,197,94,0.15);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.15);
  --accent-blue: #3b82f6;
  --accent-blue-dim: rgba(59,130,246,0.15);
  --accent-yellow: #eab308;
  --accent-yellow-dim: rgba(234,179,8,0.15);
  --accent-purple: #a855f7;
  --accent-purple-dim: rgba(168,85,247,0.15);
  --accent-cyan: #06b6d4;
  --gradient-score: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

.mono { font-family: 'JetBrains Mono', monospace; }

/* â”€â”€ Header â”€â”€â”€ */
.header {
  background: linear-gradient(180deg, #111827 0%, var(--bg-primary) 100%);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}

.header-inner {
  max-width: 1440px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}

.logo-area {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  width: 36px; height: 36px;
  background: var(--gradient-score);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 900;
  color: white;
}

.logo-text h1 {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-text .sub {
  font-size: 11px;
  color: var(--text-muted);
}

.update-badge {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 11px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.update-dot {
  width: 7px; height: 7px;
  background: var(--accent-green);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* â”€â”€ Market Overview Cards â”€â”€â”€ */
.overview-section {
  max-width: 1440px;
  margin: 20px auto;
  padding: 0 20px;
}

.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.ov-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: border-color 0.2s;
}

.ov-card:hover { border-color: var(--accent-blue); }

.ov-card .label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.ov-card .value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 26px;
  font-weight: 700;
}

.ov-card .sub-value {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* â”€â”€ Sector Heatmap â”€â”€â”€ */
.sector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
  margin-bottom: 20px;
}

.sector-bar {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.sector-bar:hover { border-color: var(--accent-blue); transform: translateY(-1px); }

.sector-bar .fill {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  opacity: 0.1;
  border-radius: 10px;
  transition: width 0.6s ease;
}

.sector-bar .info {
  position: relative;
  z-index: 1;
}

.sector-bar .sname {
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 130px;
}

.sector-bar .sscore {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px;
  font-weight: 700;
  position: relative;
  z-index: 1;
}

/* â”€â”€ Controls Bar â”€â”€â”€ */
.controls {
  max-width: 1440px;
  margin: 0 auto 16px;
  padding: 0 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

.search-box {
  flex: 1;
  min-width: 200px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  color: var(--text-primary);
  font-size: 14px;
  font-family: 'Noto Sans KR', sans-serif;
  outline: none;
  transition: border-color 0.2s;
}

.search-box:focus { border-color: var(--accent-blue); }
.search-box::placeholder { color: var(--text-muted); }

.filter-group {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.filter-btn {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 14px;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  font-family: 'Noto Sans KR', sans-serif;
}

.filter-btn:hover { border-color: var(--text-secondary); }
.filter-btn.active {
  background: var(--accent-blue-dim);
  border-color: var(--accent-blue);
  color: var(--accent-blue);
}

.sort-select {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text-primary);
  font-size: 12px;
  font-family: 'Noto Sans KR', sans-serif;
  cursor: pointer;
  outline: none;
}

.count-badge {
  font-size: 12px;
  color: var(--text-muted);
  padding: 8px 0;
}

/* â”€â”€ Stock Table â”€â”€â”€ */
.table-section {
  max-width: 1440px;
  margin: 0 auto;
  padding: 0 20px 40px;
}

.stock-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 4px;
}

.stock-table thead th {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  padding: 8px 12px;
  text-align: left;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  position: sticky;
  top: 68px;
  background: var(--bg-primary);
  z-index: 10;
}

.stock-table thead th:hover { color: var(--text-secondary); }

.stock-row {
  cursor: pointer;
  transition: all 0.15s;
}

.stock-row:hover td { background: var(--bg-hover); }

.stock-row td {
  background: var(--bg-card);
  padding: 12px;
  font-size: 13px;
  border-top: 1px solid transparent;
  border-bottom: 1px solid transparent;
  vertical-align: middle;
}

.stock-row td:first-child { border-radius: 10px 0 0 10px; border-left: 1px solid var(--border); }
.stock-row td:last-child { border-radius: 0 10px 10px 0; border-right: 1px solid var(--border); }
.stock-row td { border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }

.ticker-cell {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ticker-symbol {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  font-size: 14px;
  color: var(--accent-blue);
}

.ticker-name {
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 140px;
}

.score-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score-bar-bg {
  width: 60px;
  height: 6px;
  background: var(--bg-primary);
  border-radius: 3px;
  overflow: hidden;
}

.score-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease;
}

.score-num {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  font-size: 16px;
  min-width: 30px;
}

.score-change {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
}

.signal-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  white-space: nowrap;
}

.signal-STRONG_BUY { background: var(--accent-green-dim); color: var(--accent-green); border: 1px solid rgba(34,197,94,0.3); }
.signal-BUY { background: var(--accent-blue-dim); color: var(--accent-blue); border: 1px solid rgba(59,130,246,0.3); }
.signal-HOLD { background: var(--accent-yellow-dim); color: var(--accent-yellow); border: 1px solid rgba(234,179,8,0.3); }
.signal-SELL { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid rgba(239,68,68,0.3); }

.profit-cell { white-space: nowrap; }

.profit-zone {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  margin-right: 3px;
  font-weight: 600;
}

.zone-reached { background: var(--accent-green-dim); color: var(--accent-green); }
.zone-pending { background: var(--bg-primary); color: var(--text-muted); }

.exit-warning {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 10px;
  font-weight: 600;
  background: var(--accent-red-dim);
  color: var(--accent-red);
  border: 1px solid rgba(239,68,68,0.3);
}

.pos { color: var(--accent-green); }
.neg { color: var(--accent-red); }

/* â”€â”€ Detail Panel â”€â”€â”€ */
.detail-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  backdrop-filter: blur(4px);
}

.detail-overlay.show { display: flex; align-items: center; justify-content: center; }

.detail-panel {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 16px;
  width: 90%;
  max-width: 700px;
  max-height: 85vh;
  overflow-y: auto;
  padding: 28px;
  position: relative;
}

.detail-close {
  position: absolute;
  top: 16px; right: 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s;
}

.detail-close:hover { border-color: var(--accent-red); color: var(--accent-red); }

.detail-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 24px;
  padding-right: 40px;
}

.detail-ticker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 28px;
  font-weight: 700;
  color: var(--accent-blue);
}

.detail-name {
  font-size: 14px;
  color: var(--text-secondary);
}

.detail-sector {
  font-size: 11px;
  background: var(--bg-card);
  padding: 3px 10px;
  border-radius: 6px;
  color: var(--text-muted);
  border: 1px solid var(--border);
  margin-top: 4px;
  display: inline-block;
}

.detail-score-big {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-left: auto;
}

.big-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 48px;
  font-weight: 700;
  line-height: 1;
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.d-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
}

.d-card h4 {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.d-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 12px;
}

.d-row .d-label { color: var(--text-secondary); }
.d-row .d-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

.backtest-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
}

.backtest-section h4 {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.bt-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
}

.bt-stat {
  text-align: center;
  padding: 10px;
  background: var(--bg-primary);
  border-radius: 8px;
}

.bt-stat .bt-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
}

.bt-stat .bt-label {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 2px;
}

/* â”€â”€ Scrollbar â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ Mobile â”€â”€â”€ */
@media (max-width: 768px) {
  .header-inner { justify-content: center; text-align: center; }
  .overview-grid { grid-template-columns: repeat(2, 1fr); }
  .sector-grid { grid-template-columns: repeat(2, 1fr); }
  .controls { flex-direction: column; }
  .search-box { width: 100%; }
  .stock-table { font-size: 11px; }
  .stock-table thead th { font-size: 9px; padding: 6px 8px; }
  .stock-row td { padding: 8px; }
  .score-bar-bg { width: 40px; }
  .ticker-name { max-width: 80px; }
  .detail-panel { padding: 16px; width: 95%; }
  .detail-grid { grid-template-columns: 1fr; }
  .detail-ticker { font-size: 22px; }
  .big-score { font-size: 36px; }
  .bt-grid { grid-template-columns: repeat(2, 1fr); }
  .hide-mobile { display: none; }
}

@media (max-width: 480px) {
  .overview-grid { grid-template-columns: repeat(2, 1fr); }
  .sector-grid { grid-template-columns: 1fr; }
  .ov-card .value { font-size: 20px; }
}

/* â”€â”€ Loading â”€â”€â”€ */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  font-size: 14px;
  color: var(--text-muted);
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-inner">
    <div class="logo-area">
      <div class="logo-icon">TF</div>
      <div class="logo-text">
        <h1>S&P 500 íŠ¸ë Œë“œ íŒ”ë¡œì‰</h1>
        <div class="sub">Trend Following Dashboard Â· 500ì¢…ëª© ë¶„ì„</div>
      </div>
    </div>
    <div class="update-badge">
      <span class="update-dot"></span>
      <span id="updateTime">ë¡œë”©ì¤‘...</span>
    </div>
  </div>
</header>

<!-- Market Overview -->
<section class="overview-section">
  <div class="overview-grid" id="overviewGrid"></div>
  <div class="sector-grid" id="sectorGrid"></div>
</section>

<!-- Controls -->
<div class="controls">
  <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” ì¢…ëª© ê²€ìƒ‰ (í‹°ì»¤ ë˜ëŠ” ì´ë¦„)...">
  <div class="filter-group" id="signalFilters">
    <button class="filter-btn active" data-filter="ALL">ì „ì²´</button>
    <button class="filter-btn" data-filter="STRONG_BUY">ğŸŸ¢ ê°•í•œë§¤ìˆ˜</button>
    <button class="filter-btn" data-filter="BUY">ğŸ”µ ë§¤ìˆ˜</button>
    <button class="filter-btn" data-filter="HOLD">ğŸŸ¡ ê´€ë§</button>
    <button class="filter-btn" data-filter="SELL">ğŸ”´ ë§¤ë„</button>
  </div>
  <select class="sort-select" id="sortSelect">
    <option value="score_desc">íŠ¸ë Œë“œ ì ìˆ˜ â†“</option>
    <option value="score_asc">íŠ¸ë Œë“œ ì ìˆ˜ â†‘</option>
    <option value="gain_desc">ìˆ˜ìµë¥  â†“</option>
    <option value="gain_asc">ìˆ˜ìµë¥  â†‘</option>
    <option value="winrate_desc">ìŠ¹ë¥  â†“</option>
    <option value="change_desc">ë³€ë™í­ â†“</option>
  </select>
  <span class="count-badge" id="countBadge"></span>
</div>

<!-- Table -->
<section class="table-section">
  <table class="stock-table">
    <thead>
      <tr>
        <th>#</th>
        <th>ì¢…ëª©</th>
        <th>ê°€ê²©</th>
        <th>íŠ¸ë Œë“œ ì ìˆ˜</th>
        <th>ì‹ í˜¸</th>
        <th>ìˆ˜ìµ (ì§„ì… ì´í›„)</th>
        <th class="hide-mobile">ìµì ˆ êµ¬ê°„</th>
        <th class="hide-mobile">EXIT ê²½ê³ </th>
        <th class="hide-mobile">ìŠ¹ë¥ </th>
      </tr>
    </thead>
    <tbody id="stockBody"></tbody>
  </table>
</section>

<!-- Detail Overlay -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<script>
let DATA = null;
let currentFilter = 'ALL';
let currentSort = 'score_desc';
let currentSectorFilter = null;
let searchTerm = '';

// â”€â”€ Load Data â”€â”€
async function loadData() {
  try {
    const resp = await fetch('trend_data.json');
    DATA = await resp.json();
  } catch(e) {
    // Fallback: data embedded or error
    document.getElementById('stockBody').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. trend_data.jsonì„ í™•ì¸í•´ì£¼ì„¸ìš”.</td></tr>';
    return;
  }
  render();
}

function getScoreColor(score) {
  if (score >= 75) return 'var(--accent-green)';
  if (score >= 60) return 'var(--accent-blue)';
  if (score >= 40) return 'var(--accent-yellow)';
  return 'var(--accent-red)';
}

function getSignalKR(signal) {
  const map = {
    'STRONG_BUY': 'ê°•í•œë§¤ìˆ˜',
    'BUY': 'ë§¤ìˆ˜',
    'HOLD': 'ê´€ë§',
    'SELL': 'ë§¤ë„'
  };
  return map[signal] || signal;
}

function formatNum(n) {
  if (n === undefined || n === null) return '-';
  return n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// â”€â”€ Render Overview â”€â”€
function renderOverview() {
  const ms = DATA.market_summary;
  const cards = [
    { label: 'ë¶„ì„ ì¢…ëª©', value: ms.total_stocks, color: 'var(--text-primary)' },
    { label: 'í‰ê·  ì ìˆ˜', value: ms.avg_score, color: getScoreColor(ms.avg_score), sub: `ì¤‘ì•™ê°’ ${ms.median_score}` },
    { label: 'ğŸŸ¢ ê°•í•œë§¤ìˆ˜', value: ms.strong_buy_count, color: 'var(--accent-green)', sub: `${(ms.strong_buy_count/ms.total_stocks*100).toFixed(1)}%` },
    { label: 'ğŸ”µ ë§¤ìˆ˜', value: ms.buy_count, color: 'var(--accent-blue)', sub: `${(ms.buy_count/ms.total_stocks*100).toFixed(1)}%` },
    { label: 'ğŸŸ¡ ê´€ë§', value: ms.hold_count, color: 'var(--accent-yellow)', sub: `${(ms.hold_count/ms.total_stocks*100).toFixed(1)}%` },
    { label: 'ğŸ”´ ë§¤ë„', value: ms.sell_count, color: 'var(--accent-red)', sub: `${(ms.sell_count/ms.total_stocks*100).toFixed(1)}%` },
  ];

  document.getElementById('overviewGrid').innerHTML = cards.map(c => `
    <div class="ov-card">
      <div class="label">${c.label}</div>
      <div class="value mono" style="color:${c.color}">${c.value}</div>
      ${c.sub ? `<div class="sub-value">${c.sub}</div>` : ''}
    </div>
  `).join('');
}

// â”€â”€ Render Sectors â”€â”€
function renderSectors() {
  const ss = DATA.sector_summary;
  const sorted = Object.entries(ss).sort((a,b) => b[1].avg_score - a[1].avg_score);

  document.getElementById('sectorGrid').innerHTML = sorted.map(([name, d]) => {
    const color = getScoreColor(d.avg_score);
    const pct = d.avg_score;
    const isActive = currentSectorFilter === name;
    return `
      <div class="sector-bar ${isActive ? 'active' : ''}" onclick="toggleSectorFilter('${name}')" style="${isActive ? `border-color:${color}` : ''}">
        <div class="fill" style="width:${pct}%;background:${color}"></div>
        <div class="info">
          <div class="sname">${name}</div>
          <div style="font-size:10px;color:var(--text-muted)">${d.count}ì¢…ëª© Â· ë§¤ìˆ˜ ${d.strong_buy + d.buy}</div>
        </div>
        <div class="sscore" style="color:${color}">${d.avg_score}</div>
      </div>
    `;
  }).join('');
}

function toggleSectorFilter(sector) {
  currentSectorFilter = currentSectorFilter === sector ? null : sector;
  renderSectors();
  renderTable();
}

// â”€â”€ Filter & Sort â”€â”€
function getFilteredStocks() {
  let stocks = [...DATA.stocks];

  if (searchTerm) {
    const q = searchTerm.toLowerCase();
    stocks = stocks.filter(s => 
      s.ticker.toLowerCase().includes(q) || 
      s.name.toLowerCase().includes(q)
    );
  }

  if (currentFilter !== 'ALL') {
    stocks = stocks.filter(s => s.signal === currentFilter);
  }

  if (currentSectorFilter) {
    stocks = stocks.filter(s => s.sector === currentSectorFilter);
  }

  switch(currentSort) {
    case 'score_desc': stocks.sort((a,b) => b.trend_score - a.trend_score); break;
    case 'score_asc': stocks.sort((a,b) => a.trend_score - b.trend_score); break;
    case 'gain_desc': stocks.sort((a,b) => b.profit_taking.gain_since_signal - a.profit_taking.gain_since_signal); break;
    case 'gain_asc': stocks.sort((a,b) => a.profit_taking.gain_since_signal - b.profit_taking.gain_since_signal); break;
    case 'winrate_desc': stocks.sort((a,b) => b.backtest.win_rate - a.backtest.win_rate); break;
    case 'change_desc': stocks.sort((a,b) => Math.abs(b.change_pct) - Math.abs(a.change_pct)); break;
  }

  return stocks;
}

// â”€â”€ Render Table â”€â”€
function renderTable() {
  const stocks = getFilteredStocks();
  document.getElementById('countBadge').textContent = `${stocks.length}ì¢…ëª©`;

  const rows = stocks.map((s, i) => {
    const sc = getScoreColor(s.trend_score);
    const pt = s.profit_taking;
    const bt = s.backtest;
    const gainClass = pt.gain_since_signal >= 0 ? 'pos' : 'neg';
    const chgClass = s.change_pct >= 0 ? 'pos' : 'neg';
    const scChangeHtml = s.score_change !== 0 
      ? `<span class="score-change" style="background:${s.score_change > 0 ? 'var(--accent-green-dim)' : 'var(--accent-red-dim)'};color:${s.score_change > 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.score_change > 0 ? '+' : ''}${s.score_change}</span>` 
      : '';

    const exitWarnings = [];
    if (pt.ema10_exit_warning) exitWarnings.push('EMA10â†“');
    if (pt.score_drop_warning) exitWarnings.push('ì ìˆ˜â†“');
    const exitHtml = exitWarnings.length > 0 
      ? exitWarnings.map(w => `<span class="exit-warning">âš  ${w}</span>`).join(' ') 
      : '<span style="color:var(--text-muted);font-size:11px">â€”</span>';

    return `
      <tr class="stock-row" onclick="showDetail('${s.ticker}')">
        <td style="color:var(--text-muted);font-size:11px" class="mono">${i+1}</td>
        <td>
          <div class="ticker-cell">
            <span class="ticker-symbol">${s.ticker}</span>
            <span class="ticker-name">${s.name}</span>
          </div>
        </td>
        <td>
          <div class="mono" style="font-weight:600">$${formatNum(s.price)}</div>
          <div class="mono ${chgClass}" style="font-size:11px">${s.change_pct >= 0 ? '+' : ''}${s.change_pct}%</div>
        </td>
        <td>
          <div class="score-cell">
            <span class="score-num" style="color:${sc}">${s.trend_score}</span>
            <div class="score-bar-bg">
              <div class="score-bar-fill" style="width:${s.trend_score}%;background:${sc}"></div>
            </div>
            ${scChangeHtml}
          </div>
        </td>
        <td><span class="signal-badge signal-${s.signal}">${getSignalKR(s.signal)}</span></td>
        <td>
          <span class="mono ${gainClass}" style="font-weight:600;font-size:14px">${pt.gain_since_signal >= 0 ? '+' : ''}${pt.gain_since_signal}%</span>
          <div style="font-size:10px;color:var(--text-muted)">${pt.days_in_trend}ì¼</div>
        </td>
        <td class="profit-cell hide-mobile">
          <span class="profit-zone ${pt.reached_10 ? 'zone-reached' : 'zone-pending'}">10%</span>
          <span class="profit-zone ${pt.reached_20 ? 'zone-reached' : 'zone-pending'}">20%</span>
          <span class="profit-zone ${pt.reached_30 ? 'zone-reached' : 'zone-pending'}">30%</span>
        </td>
        <td class="hide-mobile">${exitHtml}</td>
        <td class="hide-mobile">
          <span class="mono" style="font-weight:600;color:${bt.win_rate >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}">${bt.win_rate}%</span>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('stockBody').innerHTML = rows || '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
}

// â”€â”€ Detail Panel â”€â”€
function showDetail(ticker) {
  const s = DATA.stocks.find(x => x.ticker === ticker);
  if (!s) return;

  const sc = getScoreColor(s.trend_score);
  const pt = s.profit_taking;
  const bt = s.backtest;
  const ind = s.indicators;

  const html = `
    <div class="detail-close" onclick="closeDetail()">âœ•</div>
    <div class="detail-header">
      <div>
        <div class="detail-ticker">${s.ticker}</div>
        <div class="detail-name">${s.name}</div>
        <span class="detail-sector">${s.sector}</span>
      </div>
      <div class="detail-score-big">
        <span class="signal-badge signal-${s.signal}" style="font-size:13px;padding:6px 14px">${getSignalKR(s.signal)}</span>
        <div class="big-score" style="color:${sc}">${s.trend_score}</div>
      </div>
    </div>

    <div class="detail-grid">
      <!-- Price Info -->
      <div class="d-card">
        <h4>ğŸ“ˆ ê°€ê²© ì •ë³´</h4>
        <div class="d-row"><span class="d-label">í˜„ì¬ê°€</span><span class="d-val">$${formatNum(s.price)}</span></div>
        <div class="d-row"><span class="d-label">ì¼ê°„ ë³€ë™</span><span class="d-val ${s.change_pct >= 0 ? 'pos' : 'neg'}">${s.change_pct >= 0 ? '+' : ''}${s.change_pct}%</span></div>
        <div class="d-row"><span class="d-label">52ì£¼ ìµœê³ </span><span class="d-val">$${formatNum(s.high_52w)}</span></div>
        <div class="d-row"><span class="d-label">52ì£¼ ìµœì €</span><span class="d-val">$${formatNum(s.low_52w)}</span></div>
        <div class="d-row"><span class="d-label">ê³ ì  ëŒ€ë¹„</span><span class="d-val neg">${s.pct_from_high}%</span></div>
      </div>

      <!-- Indicators -->
      <div class="d-card">
        <h4>ğŸ”§ ê¸°ìˆ ì  ì§€í‘œ</h4>
        <div class="d-row"><span class="d-label">SMA 50</span><span class="d-val">$${formatNum(ind.sma_50)}</span></div>
        <div class="d-row"><span class="d-label">SMA 200</span><span class="d-val">$${formatNum(ind.sma_200)}</span></div>
        <div class="d-row"><span class="d-label">RSI (14)</span><span class="d-val" style="color:${ind.rsi > 70 ? 'var(--accent-red)' : ind.rsi < 30 ? 'var(--accent-green)' : 'var(--text-primary)'}">${ind.rsi}</span></div>
        <div class="d-row"><span class="d-label">ADX</span><span class="d-val" style="color:${ind.adx > 25 ? 'var(--accent-green)' : 'var(--text-muted)'}">${ind.adx}</span></div>
        <div class="d-row"><span class="d-label">Supertrend</span><span class="d-val" style="color:${ind.supertrend_dir === 'UP' ? 'var(--accent-green)' : 'var(--accent-red)'}">${ind.supertrend_dir === 'UP' ? 'â–² ìƒìŠ¹' : 'â–¼ í•˜ë½'}</span></div>
        <div class="d-row"><span class="d-label">ATR</span><span class="d-val">$${formatNum(ind.atr)}</span></div>
      </div>

      <!-- Profit Taking -->
      <div class="d-card">
        <h4>ğŸ’° ìµì ˆ ì‹ í˜¸</h4>
        <div class="d-row"><span class="d-label">ì§„ì…ê°€</span><span class="d-val">$${formatNum(pt.entry_price)}</span></div>
        <div class="d-row"><span class="d-label">ì§„ì…ì¼</span><span class="d-val">${pt.entry_date}</span></div>
        <div class="d-row"><span class="d-label">ìˆ˜ìµë¥ </span><span class="d-val ${pt.gain_since_signal >= 0 ? 'pos' : 'neg'}">${pt.gain_since_signal >= 0 ? '+' : ''}${pt.gain_since_signal}%</span></div>
        <div class="d-row"><span class="d-label">ë³´ìœ ì¼</span><span class="d-val">${pt.days_in_trend}ì¼</span></div>
        <div class="d-row"><span class="d-label">ATR íŠ¸ë ˆì¼ë§ ìŠ¤í†±</span><span class="d-val">$${formatNum(pt.atr_trailing_stop)}</span></div>
        <div class="d-row"><span class="d-label">ìŠ¤í†± ê±°ë¦¬</span><span class="d-val neg">${pt.stop_distance_pct}%</span></div>
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
          <span class="profit-zone ${pt.reached_10 ? 'zone-reached' : 'zone-pending'}" style="font-size:12px;padding:4px 10px">+10% $${formatNum(pt.profit_zone_10)} ${pt.reached_10 ? 'âœ“' : ''}</span>
          <span class="profit-zone ${pt.reached_20 ? 'zone-reached' : 'zone-pending'}" style="font-size:12px;padding:4px 10px">+20% $${formatNum(pt.profit_zone_20)} ${pt.reached_20 ? 'âœ“' : ''}</span>
          <span class="profit-zone ${pt.reached_30 ? 'zone-reached' : 'zone-pending'}" style="font-size:12px;padding:4px 10px">+30% $${formatNum(pt.profit_zone_30)} ${pt.reached_30 ? 'âœ“' : ''}</span>
        </div>
      </div>

      <!-- Exit Warnings -->
      <div class="d-card">
        <h4>ğŸš¨ EXIT ê²½ê³ </h4>
        <div class="d-row">
          <span class="d-label">EMA-10 ì´íƒˆ</span>
          <span class="d-val" style="color:${pt.ema10_exit_warning ? 'var(--accent-red)' : 'var(--accent-green)'}">
            ${pt.ema10_exit_warning ? 'âš  ê²½ê³ ' : 'âœ“ ì•ˆì „'}
          </span>
        </div>
        <div class="d-row">
          <span class="d-label">ì ìˆ˜ í•˜ë½ ê²½ê³  (&lt;40)</span>
          <span class="d-val" style="color:${pt.score_drop_warning ? 'var(--accent-red)' : 'var(--accent-green)'}">
            ${pt.score_drop_warning ? 'âš  ê²½ê³ ' : 'âœ“ ì•ˆì „'}
          </span>
        </div>
        <div style="margin-top:10px;padding:10px;background:var(--bg-primary);border-radius:8px;font-size:11px;color:var(--text-muted)">
          ${s.trend_score >= 60 ? 'âœ… íŠ¸ë Œë“œ ìœ ì§€ ì¤‘ â€” ë³´ìœ  ì§€ì†' : 
            s.trend_score >= 40 ? 'âš ï¸ íŠ¸ë Œë“œ ì•½í™” â€” ë¶€ë¶„ ìµì ˆ ê³ ë ¤' : 
            'ğŸ”´ íŠ¸ë Œë“œ ì´íƒˆ â€” ë§¤ë„ ì¶”ì²œ'}
        </div>
      </div>
    </div>

    <!-- Backtest -->
    <div class="backtest-section">
      <h4>ğŸ“Š ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ (1ë…„)</h4>
      <div class="bt-grid">
        <div class="bt-stat">
          <div class="bt-val" style="color:${bt.win_rate >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}">${bt.win_rate}%</div>
          <div class="bt-label">ìŠ¹ë¥ </div>
        </div>
        <div class="bt-stat">
          <div class="bt-val">${bt.total_trades}</div>
          <div class="bt-label">ì´ ê±°ë˜</div>
        </div>
        <div class="bt-stat">
          <div class="bt-val pos">+${bt.avg_winner}%</div>
          <div class="bt-label">í‰ê·  ìˆ˜ìµ</div>
        </div>
        <div class="bt-stat">
          <div class="bt-val neg">${bt.avg_loser}%</div>
          <div class="bt-label">í‰ê·  ì†ì‹¤</div>
        </div>
        <div class="bt-stat">
          <div class="bt-val" style="color:${bt.total_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${bt.total_return >= 0 ? '+' : ''}${bt.total_return}%</div>
          <div class="bt-label">ì „ëµ ìˆ˜ìµë¥ </div>
        </div>
        <div class="bt-stat">
          <div class="bt-val" style="color:${bt.buy_hold_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${bt.buy_hold_return >= 0 ? '+' : ''}${bt.buy_hold_return}%</div>
          <div class="bt-label">ë‹¨ìˆœ ë³´ìœ </div>
        </div>
        <div class="bt-stat">
          <div class="bt-val neg">${bt.max_drawdown}%</div>
          <div class="bt-label">ìµœëŒ€ ë‚™í­</div>
        </div>
        <div class="bt-stat">
          <div class="bt-val" style="color:${(bt.total_return - bt.buy_hold_return) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${(bt.total_return - bt.buy_hold_return) >= 0 ? '+' : ''}${(bt.total_return - bt.buy_hold_return).toFixed(1)}%</div>
          <div class="bt-label">ì´ˆê³¼ ìˆ˜ìµ</div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('detailPanel').innerHTML = html;
  document.getElementById('detailOverlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('show');
  document.body.style.overflow = '';
}

// â”€â”€ Events â”€â”€
document.getElementById('searchInput').addEventListener('input', (e) => {
  searchTerm = e.target.value;
  renderTable();
});

document.getElementById('signalFilters').addEventListener('click', (e) => {
  if (e.target.classList.contains('filter-btn')) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    currentFilter = e.target.dataset.filter;
    renderTable();
  }
});

document.getElementById('sortSelect').addEventListener('change', (e) => {
  currentSort = e.target.value;
  renderTable();
});

document.getElementById('detailOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('detailOverlay')) closeDetail();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeDetail();
});

// â”€â”€ Render All â”€â”€
function render() {
  document.getElementById('updateTime').textContent = `ì—…ë°ì´íŠ¸: ${DATA.updated}`;
  renderOverview();
  renderSectors();
  renderTable();
}

loadData();
</script>
</body>
</html>
